<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Noble Builder</title>
  <style>
    :root{
      --bg:#0f0f12;
      --panel:#171720;
      --panel2:#1d1d29;
      --text:#f2f2f7;
      --muted:#a9a9b8;
      --line:#2a2a3a;
      --bad:#ff5a5f;
      --good:#4ade80;
      --warn:#fbbf24;
      --btn:#2a2a3a;
      --btnHover:#36364e;
      --input:#101018;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      background: linear-gradient(180deg, #151522, #101018);
      border-bottom:1px solid var(--line);
      padding:14px 16px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
    }
    header h1{ margin:0; font-size:16px; letter-spacing:0.2px; font-weight:700; }
    .sub{color:var(--muted); font-size:12px; margin-top:2px;}
    .hdr-left{display:flex; flex-direction:column}
    .hdr-actions{display:flex; flex-wrap:wrap; gap:8px; align-items:center}

    button{
      border:1px solid var(--line);
      background:var(--btn);
      color:var(--text);
      border-radius:10px;
      padding:8px 10px;
      font-weight:600;
      cursor:pointer;
      font-size:13px;
    }
    button:hover{background:var(--btnHover)}
    button:disabled{opacity:.55; cursor:not-allowed}

    main{
      padding:16px;
      display:grid;
      grid-template-columns: 1.8fr 1fr;
      gap:16px;
      max-width:1200px;
      margin:0 auto;
    }
    @media (max-width: 980px){ main{grid-template-columns:1fr} }

    .panel{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 8px 24px rgba(0,0,0,.25);
    }
    .row{display:grid; gap:10px}
    .row.two{grid-template-columns:1fr 1fr}
    @media (max-width: 700px){ .row.two{grid-template-columns:1fr} }

    label{
      display:block;
      color:var(--muted);
      font-size:12px;
      margin: 8px 0 6px;
    }
    input[type="text"], input[type="number"], select, textarea{
      width:100%;
      background:var(--input);
      color:var(--text);
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 10px;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:80px; resize:vertical}

    .muted{color:var(--muted); font-size:12px}
    .tiny{font-size:11px; color:var(--muted)}
    .hr{height:1px; background:var(--line); margin:12px 0}

    .cards{display:flex; flex-direction:column; gap:10px; margin-top:8px}
    .card{
      background:var(--panel2);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
    }
    .card-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border:1px solid var(--line);
      padding:4px 8px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      background:rgba(255,255,255,0.02);
      white-space:nowrap;
    }
    .pill.good{border-color: rgba(74,222,128,.45); color:var(--good)}
    .pill.bad{border-color: rgba(255,90,95,.45); color:var(--bad)}
    .pill.warn{border-color: rgba(251,191,36,.45); color:var(--warn)}
    .card-title{
      display:flex; flex-wrap:wrap;
      gap:8px;
      align-items:center;
      font-weight:800;
    }

    .summary-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .stat{
      background:rgba(255,255,255,0.03);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
    }
    .stat .k{color:var(--muted); font-size:12px}
    .stat .v{font-weight:800; font-size:16px; margin-top:4px}

    .badBorder{border-color: rgba(255,90,95,.45) !important}
    .goodBorder{border-color: rgba(74,222,128,.45) !important}

    .errors{
      margin-top:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .err{
      border:1px solid rgba(255,90,95,.35);
      background: rgba(255,90,95,.08);
      border-radius:14px;
      padding:10px;
      font-size:13px;
    }
    .warnBox{
      border:1px solid rgba(251,191,36,.35);
      background: rgba(251,191,36,.08);
      border-radius:14px;
      padding:10px;
      font-size:13px;
    }
    .okBox{
      border:1px solid rgba(74,222,128,.35);
      background: rgba(74,222,128,.08);
      border-radius:14px;
      padding:10px;
      font-size:13px;
    }

    .btnRow{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px}

    .slotGrid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 900px){
      .slotGrid{grid-template-columns:1fr}
    }

    .slotBox{
      border:1px solid var(--line);
      background: rgba(255,255,255,0.02);
      border-radius:14px;
      padding:10px;
    }
    .slotBox .slotHdr{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      margin-bottom:6px;
    }
    .slotBox .slotHdr strong{font-size:13px}
    .slotBox .slotHdr span{font-size:11px; color:var(--muted)}
    .slotAddRow{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:8px;
      align-items:end;
    }
    @media (max-width: 700px){
      .slotAddRow{grid-template-columns:1fr}
    }

    .equipList{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:8px;
    }
    .equipChip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--line);
      background: rgba(255,255,255,0.02);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--text);
    }
    .equipChip .x{
      cursor:pointer;
      color:var(--muted);
      font-weight:900;
      user-select:none;
    }
    .equipChip .x:hover{color:var(--text)}
    .tagMini{color:var(--muted); font-size:11px}

    @media print{
      header, .noPrint{display:none !important}
      body{background:#fff; color:#000}
      .panel{box-shadow:none; border:1px solid #ddd}
      .card{border:1px solid #ddd}
      .pill{border:1px solid #ddd; color:#444}
      .muted{color:#444}
      .equipChip{border:1px solid #ddd}
      .slotBox{border:1px solid #ddd}
    }
  </style>
</head>

<body>
  <header class="noPrint">
    <div class="hdr-left">
      <h1>Mirrored City Warband Builder</h1>
      <div class="sub">Noble Builder</div>
    </div>
    <div class="hdr-actions">
      <button id="btnExport">Export</button>
      <button id="btnImport">Import</button>
      <button id="btnPrint">Print</button>
      <button id="btnReset">Reset</button>
    </div>
  </header>

  <main>
    <!-- LEFT -->
    <section class="panel">
      <div class="row two">
        <div>
          <label>Roster Name</label>
          <input id="rosterName" type="text" placeholder="e.g., Jeff's cool list" />
        </div>
        <div>
          <label>Creation Mode</label>
          <select id="creationMode">
            <option value="starting">Starting Warband (creation rules enforced)</option>
          </select>
          <div class="tiny">
            Starting mode hides <strong>RARE</strong> items (except <strong>Unique equipment</strong>).
          </div>
        </div>
      </div>

      <div class="row two">
        <div>
          <label>Warband</label>
          <select id="warbandSelect"></select>
          <div id="warbandDesc" class="tiny"></div>
        </div>

        <div>
          <label>Archetype</label>
          <select id="archetypeSelect"></select>
          <div id="archetypeDesc" class="tiny"></div>
        </div>
      </div>

      <div class="row two">
        <div>
          <label>Leader</label>
          <select id="leaderSelect"></select>
          <div class="tiny">
            Leader counts as a <strong>Stat Card</strong> and counts toward the <strong>Hero</strong> cap.
          </div>
        </div>
        <div>
          <label class="muted">Notes</label>
          <div class="tiny">
            Archetype controls which Leaders/Heroes/Henchmen you can select.
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="btnRow noPrint">
        <button id="btnAddHero">+ Add Hero Card</button>
        <button id="btnAddHench">+ Add Henchman Card</button>
      </div>

      <div class="tiny">
        Equipment slots per Stat Card: <strong>3 Weapons</strong>, <strong>1 Helmet</strong>, <strong>1 Armor</strong>, <strong>1 Shield</strong>, <strong>3 Everything Else</strong>.
      </div>

      <div class="cards" id="cards"></div>
    </section>

    <!-- RIGHT -->
    <aside class="panel">
      <h2 style="margin:0 0 10px 0; font-size:16px;">Summary</h2>

      <div class="summary-grid">
        <div class="stat" id="statLumens">
          <div class="k">Lumens</div>
          <div class="v" id="lumensText">0 / 500</div>
          <div class="tiny" id="lumensSub"></div>
        </div>
        <div class="stat" id="statCards">
          <div class="k">Stat Cards (incl. Leader)</div>
          <div class="v" id="cardsText">0 / 5</div>
          <div class="tiny" id="cardsSub"></div>
        </div>
        <div class="stat" id="statHeroes">
          <div class="k">Heroes (incl. Leader)</div>
          <div class="v" id="heroesText">0 / 3</div>
          <div class="tiny">Max 3 at creation (Leader included).</div>
        </div>
        <div class="stat" id="statReqs">
          <div class="k">Requirements</div>
          <div style="margin-top:8px; display:flex; flex-wrap:wrap; gap:6px;">
            <span class="pill" id="reqLeader">Leader</span>
            <span class="pill" id="reqHench">Henchman Card</span>
            <span class="pill" id="reqOneMore">+1 Card</span>
            <span class="pill" id="reqMinCards">≥3 Cards</span>
            <span class="pill" id="reqNoSells">No Sellswords</span>
          </div>
        </div>
      </div>

      <div class="errors" id="messages"></div>

      <div class="hr"></div>

      <label class="noPrint">Roster JSON (read-only preview)</label>
      <textarea id="jsonPreview" readonly></textarea>
      <div class="tiny">Export/Import uses this format. Local save is in your browser only.</div>
    </aside>
  </main>

<script>
/* =========================================================
   RULES
   ========================================================= */

const RULES = {
  startingLumens: 500,
  startingStatCardsMax: 5,
  startingStatCardsMinFilled: 3,
  startingMaxHeroesIncludingLeader: 3,
  sellswordsAllowedAtCreation: false,

  equipSlots: {
    WEAPON: 3,
    HELMET: 1,
    ARMOR: 1,
    SHIELD: 1,
    OTHER: 3
  }
};

/* =========================================================
   UNITS (Order of the Last Sun)
   ========================================================= */

const UNITS = [
  { id: "ols_vindicator", name: "Vindicator", type: "LEADER", cost: 70, tags: [], limit: "1" },
  { id: "ols_justicar", name: "Justicar", type: "LEADER", cost: 65, tags: [], limit: "1" },
  { id: "ols_dawnfather", name: "Dawnfather / Dawnmother", type: "LEADER", cost: 60, tags: [], limit: "0-1" },

  { id: "ols_purifier", name: "Purifier", type: "HERO", cost: 40, tags: [], limit: "0-3" },
  { id: "ols_suntouched_vessel", name: "Suntouched Vessel", type: "HERO", cost: 50, tags: [], limit: "" },
  { id: "ols_chaplain", name: "Chaplain", type: "HERO", cost: 55, tags: [], limit: "0-1" },
  { id: "ols_sunward_initiate", name: "Sunward Initiate", type: "HERO", cost: 25, tags: [], limit: "0-2" },
  { id: "ols_dawnguard", name: "Dawnguard", type: "HERO", cost: 45, tags: [], limit: "0-2" },

  { id: "ols_warhound", name: "Warhound", type: "HENCHMAN", cost: 15, tags: [], limit: "0-6" },
  { id: "ols_man_at_arms", name: "Man-at-Arms", type: "HENCHMAN", cost: 25, tags: [], limit: "" },
  { id: "ols_dawner", name: "Dawner", type: "HENCHMAN", cost: 20, tags: ["HORDE"], limit: "" },
  { id: "ols_vigilant", name: "Vigilant", type: "HENCHMAN", cost: 25, tags: [], limit: "0-6" },

  { id: "sell_blade_for_hire", name: "Blade for Hire", type: "SELLSWORD", cost: 60, tags: [], limit: "" }
];

/* =========================================================
   EQUIPMENT (central catalog)
   ========================================================= */

const EQUIPMENT_CATALOG = {
  eq_axe: { id:"eq_axe", name:"Axe", tags:["WEAPON","MELEE"], cost:8 },
  eq_dagger: { id:"eq_dagger", name:"Dagger", tags:["WEAPON","MELEE"], cost:0, note:"1st Free / 2" },
  eq_flail: { id:"eq_flail", name:"Flail", tags:["WEAPON","MELEE"], cost:18 },
  eq_great_weapon: { id:"eq_great_weapon", name:"Great Weapon", tags:["WEAPON","MELEE","TWO_HANDED"], cost:25 },
  eq_halberd: { id:"eq_halberd", name:"Halberd", tags:["WEAPON","MELEE","TWO_HANDED"], cost:12 },
  eq_hammer: { id:"eq_hammer", name:"Hammer", tags:["WEAPON","MELEE"], cost:8 },
  eq_mace: { id:"eq_mace", name:"Mace", tags:["WEAPON","MELEE"], cost:6 },
  eq_mace_chain: { id:"eq_mace_chain", name:"Mace and Chain", tags:["WEAPON","MELEE"], cost:20 },
  eq_sword: { id:"eq_sword", name:"Sword", tags:["WEAPON","MELEE"], cost:15 },
  eq_club: { id:"eq_club", name:"Club", tags:["WEAPON","MELEE"], cost:3 },
  eq_staff: { id:"eq_staff", name:"Staff", tags:["WEAPON","MELEE","TWO_HANDED"], cost:8 },
  eq_rapier: { id:"eq_rapier", name:"Rapier", tags:["WEAPON","MELEE"], cost:10 },
  eq_whip: { id:"eq_whip", name:"Whip", tags:["WEAPON","MELEE"], cost:5 },
  eq_spear: { id:"eq_spear", name:"Spear", tags:["WEAPON","MELEE","TWO_HANDED"], cost:10 },

  eq_crossbow: { id:"eq_crossbow", name:"Crossbow", tags:["WEAPON","RANGED"], cost:25 },
  eq_hand_crossbow: { id:"eq_hand_crossbow", name:"Hand Crossbow", tags:["WEAPON","RANGED"], cost:15 },
  eq_short_bow: { id:"eq_short_bow", name:"Short Bow", tags:["WEAPON","RANGED"], cost:10 },
  eq_long_bow: { id:"eq_long_bow", name:"Long Bow", tags:["WEAPON","RANGED"], cost:15 },
  eq_sling: { id:"eq_sling", name:"Sling", tags:["WEAPON","RANGED"], cost:9 },
  eq_javelin: { id:"eq_javelin", name:"Javelin", tags:["WEAPON","RANGED","THROWN"], cost:15 },
  eq_throwing_axe: { id:"eq_throwing_axe", name:"Throwing Axe", tags:["WEAPON","RANGED","THROWN"], cost:10 },
  eq_throwing_knives: { id:"eq_throwing_knives", name:"Throwing Knives", tags:["WEAPON","RANGED","THROWN"], cost:8 },

  eq_pistol: { id:"eq_pistol", name:"Pistol", tags:["WEAPON","BLASTPOWDER","RANGED"], cost:20 },
  eq_dueling_pistol: { id:"eq_dueling_pistol", name:"Dueling Pistol", tags:["WEAPON","BLASTPOWDER","RANGED"], cost:35 },
  eq_volley_pistol: { id:"eq_volley_pistol", name:"Volley Pistol", tags:["WEAPON","BLASTPOWDER","RANGED"], cost:30 },
  eq_blunderbuss: { id:"eq_blunderbuss", name:"Blunderbuss", tags:["WEAPON","BLASTPOWDER","RANGED"], cost:30 },
  eq_musket: { id:"eq_musket", name:"Musket", tags:["WEAPON","BLASTPOWDER","RANGED"], cost:40 },
  eq_long_rifle: { id:"eq_long_rifle", name:"Long Rifle", tags:["WEAPON","BLASTPOWDER","RANGED"], cost:100 },

  eq_helmet: { id:"eq_helmet", name:"Helmet", tags:["HELMET"], cost:5 },
  eq_great_helmet: { id:"eq_great_helmet", name:"Great Helmet", tags:["HELMET"], cost:8 },

  eq_light_armor: { id:"eq_light_armor", name:"Light Armor", tags:["ARMOR"], cost:10 },
  eq_medium_armor: { id:"eq_medium_armor", name:"Medium Armor", tags:["ARMOR"], cost:25 },
  eq_heavy_armor: { id:"eq_heavy_armor", name:"Heavy Armor", tags:["ARMOR"], cost:45 },

  eq_shield: { id:"eq_shield", name:"Shield", tags:["SHIELD"], cost:10 },
  eq_tower_shield: { id:"eq_tower_shield", name:"Tower Shield", tags:["SHIELD"], cost:18 },
  eq_buckler: { id:"eq_buckler", name:"Buckler", tags:["SHIELD"], cost:5 },

  eq_holy_symbol: { id:"eq_holy_symbol", name:"Holy Symbol", tags:["UNIVERSAL","RARE"], cost:25 },
  eq_holy_water: { id:"eq_holy_water", name:"Holy Water", tags:["UNIVERSAL","CONSUMABLE","RARE"], cost:20 },
  eq_sunfire_phial: { id:"eq_sunfire_phial", name:"Sunfire Phial", tags:["UNIVERSAL","CONSUMABLE","UNIQUE"], cost:30, uniqueToFaction:"order_of_the_last_sun" },
  eq_torch: { id:"eq_torch", name:"Torch", tags:["UNIVERSAL"], cost:2 },

  // Special materials (not selectable yet)
  eq_sunsteel_upgrade: { id:"eq_sunsteel_upgrade", name:"Sunsteel (weapon material)", tags:["SPECIAL_MATERIAL","UPGRADE"], cost:"X" },
  eq_adamantite_upgrade: { id:"eq_adamantite_upgrade", name:"Adamantite (weapon material)", tags:["SPECIAL_MATERIAL","UPGRADE"], cost:"X 2" },
  eq_mithril_upgrade: { id:"eq_mithril_upgrade", name:"Mithril (weapon material)", tags:["SPECIAL_MATERIAL","UPGRADE"], cost:"X 3" },

  // OLS Unique equipment
  eq_solar_mace: { id:"eq_solar_mace", name:"Solar Mace", tags:["WEAPON","MELEE","UNIQUE"], cost:15, uniqueToFaction:"order_of_the_last_sun" },
  eq_sun_mask: { id:"eq_sun_mask", name:"Sun Mask", tags:["HELMET","UNIQUE"], cost:5, note:"Counts as a Helmet", uniqueToFaction:"order_of_the_last_sun" },
  eq_consecrated_stake: { id:"eq_consecrated_stake", name:"Consecrated Stake", tags:["WEAPON","MELEE","UNIQUE"], cost:10, uniqueToFaction:"order_of_the_last_sun" },

  // These are modeled as discrete items for list purposes:
  // In the rules they behave like "upgrades" to another weapon, but we keep them as selectable "Other" items.
  eq_silvered_melee: { id:"eq_silvered_melee", name:"Silvered Melee Weapon", tags:["UNIVERSAL","UPGRADE","UNIQUE"], cost:10, note:"+10 (upgrade)", uniqueToFaction:"order_of_the_last_sun" },
  eq_silvered_ammo: { id:"eq_silvered_ammo", name:"Silvered Ammunition", tags:["UNIVERSAL","AMMO","UNIQUE"], cost:15, uniqueToFaction:"order_of_the_last_sun" }
};

/* =========================================================
   ORDER OF THE LAST SUN - EQUIPMENT LISTS
   (These lists drive what appears in dropdowns.)
   ========================================================= */

const OLS_EQUIP_LISTS = {
  knights_equipment: {
    id: "knights_equipment",
    name: "Knight’s Equipment",
    items: [
      "eq_axe","eq_dagger","eq_flail","eq_great_weapon","eq_halberd","eq_hammer","eq_mace","eq_mace_chain","eq_solar_mace","eq_sword",
      "eq_crossbow","eq_javelin","eq_throwing_axe",
      "eq_helmet","eq_great_helmet","eq_light_armor","eq_medium_armor","eq_heavy_armor",
      "eq_shield","eq_tower_shield"
    ],
    overrides: {
      eq_solar_mace: { onlyUnits: ["ols_vindicator","ols_dawnguard"] }
    }
  },

  clergy_equipment: {
    id: "clergy_equipment",
    name: "Clergy Equipment",
    items: [
      "eq_axe","eq_club","eq_dagger","eq_hammer","eq_mace","eq_solar_mace","eq_spear","eq_staff",
      "eq_short_bow","eq_sling",
      "eq_sun_mask","eq_light_armor","eq_medium_armor","eq_shield"
    ],
    overrides: {
      eq_solar_mace: { notUnits: ["ols_suntouched_vessel"] },
      eq_spear: { onlyUnits: ["ols_dawner"] },
      eq_short_bow: { onlyUnits: ["ols_dawner"] },
      eq_medium_armor: { onlyUnits: ["ols_dawnfather","ols_chaplain"] }
    }
  },

  special_equipment: {
    id: "special_equipment",
    name: "Special Equipment",
    items: [
      "eq_holy_symbol","eq_holy_water","eq_silvered_melee","eq_silvered_ammo","eq_sunfire_phial","eq_torch"
    ],
    overrides: {
      eq_silvered_melee: { onlyUnits: ["ols_justicar","ols_purifier"] },
      eq_silvered_ammo: { onlyUnits: ["ols_justicar","ols_purifier"] }
    }
  },

  purifiers_equipment: {
    id: "purifiers_equipment",
    name: "Purifier’s Equipment",
    items: [
      "eq_axe","eq_consecrated_stake","eq_dagger","eq_hammer","eq_mace_chain","eq_rapier","eq_sword","eq_whip",
      "eq_crossbow","eq_hand_crossbow","eq_throwing_knives",
      "eq_dueling_pistol","eq_pistol","eq_volley_pistol",
      "eq_helmet","eq_light_armor","eq_medium_armor",
      "eq_shield","eq_buckler"
    ],
    overrides: {
      eq_dueling_pistol: { onlyUnits: ["ols_justicar"] }
    }
  },

  soldiers_equipment: {
    id: "soldiers_equipment",
    name: "Soldier’s Equipment",
    items: [
      "eq_axe","eq_club","eq_dagger","eq_halberd","eq_hammer","eq_mace","eq_spear","eq_sword",
      "eq_crossbow","eq_hand_crossbow","eq_long_bow","eq_short_bow",
      "eq_blunderbuss","eq_long_rifle","eq_musket",
      "eq_helmet","eq_light_armor","eq_medium_armor",
      "eq_shield"
    ],
    overrides: {
      eq_halberd: { onlyUnits: ["ols_man_at_arms"] },
      eq_spear: { onlyUnits: ["ols_man_at_arms"] },
      eq_medium_armor: { onlyUnits: ["ols_man_at_arms"] },
      // Blastpowder Weapons (Vigilants Only)
      eq_blunderbuss: { onlyUnits: ["ols_vigilant"] },
      eq_long_rifle: { onlyUnits: ["ols_vigilant"] },
      eq_musket: { onlyUnits: ["ols_vigilant"] }
    }
  }
};

/* =========================================================
   UNIT -> WHICH LISTS IT CAN PULL FROM (BY SLOT)
   ========================================================= */

const UNIT_EQUIP_LIST_ACCESS = {
  // Leaders
  ols_vindicator: {
    WEAPON: ["knights_equipment"],
    HELMET: ["knights_equipment"],
    ARMOR:  ["knights_equipment"],
    SHIELD: ["knights_equipment"],
    OTHER:  ["special_equipment"]
  },
  ols_justicar: {
    WEAPON: ["purifiers_equipment"],
    HELMET: ["purifiers_equipment"],
    ARMOR:  ["purifiers_equipment"],
    SHIELD: ["purifiers_equipment"],
    OTHER:  ["special_equipment"]
  },
  ols_dawnfather: {
    WEAPON: ["clergy_equipment"],
    HELMET: ["clergy_equipment"],
    ARMOR:  ["clergy_equipment"],
    SHIELD: ["clergy_equipment"],
    OTHER:  ["special_equipment"]
  },

  // Heroes
  ols_purifier: {
    WEAPON: ["purifiers_equipment"],
    HELMET: ["purifiers_equipment"],
    ARMOR:  ["purifiers_equipment"],
    SHIELD: ["purifiers_equipment"],
    OTHER:  ["special_equipment"]
  },
  ols_chaplain: {
    WEAPON: ["clergy_equipment"],
    HELMET: ["clergy_equipment"],
    ARMOR:  ["clergy_equipment"],
    SHIELD: ["clergy_equipment"],
    OTHER:  ["special_equipment"]
  },
  ols_sunward_initiate: {
    WEAPON: ["clergy_equipment"],
    HELMET: ["clergy_equipment"],
    ARMOR:  ["clergy_equipment"],
    SHIELD: ["clergy_equipment"],
    OTHER:  ["special_equipment"]
  },
  ols_dawnguard: {
    WEAPON: ["knights_equipment"],
    HELMET: ["knights_equipment"],
    ARMOR:  ["knights_equipment"],
    SHIELD: ["knights_equipment"],
    OTHER:  ["special_equipment"]
  },
  ols_suntouched_vessel: {
    WEAPON: ["clergy_equipment"], // (list override prevents Solar Mace)
    HELMET: [],
    ARMOR:  [],
    SHIELD: [],
    OTHER:  ["special_equipment"]
  },

  // Henchmen
  ols_warhound: { WEAPON:[], HELMET:[], ARMOR:[], SHIELD:[], OTHER:[] },
  ols_man_at_arms: {
    WEAPON: ["soldiers_equipment"],
    HELMET: ["soldiers_equipment"],
    ARMOR:  ["soldiers_equipment"],
    SHIELD: ["soldiers_equipment"],
    OTHER:  ["special_equipment"]
  },
  ols_dawner: {
    WEAPON: ["clergy_equipment"],   // spear/short bow restricted by list override
    HELMET: ["clergy_equipment"],
    ARMOR:  ["clergy_equipment"],
    SHIELD: ["clergy_equipment"],
    OTHER:  ["special_equipment"]
  },
  ols_vigilant: {
    WEAPON: ["soldiers_equipment"], // blastpowder only shows due to list override
    HELMET: ["soldiers_equipment"],
    ARMOR:  ["soldiers_equipment"],
    SHIELD: ["soldiers_equipment"],
    OTHER:  ["special_equipment"]
  }
};

/* =========================================================
   WARBANDS + ARCHETYPES
   ========================================================= */

const WARBANDS = [
  {
    id: "order_of_the_last_sun",
    name: "Order of the Last Sun",
    description: "A sanctioned strike force of Solmir. Archetype dictates allowed units.",
    archetypes: [
      {
        id: "purifier_conclave",
        name: "Purifier Conclave",
        description: "Militant hunters of corruption. Justicar-led, warhounds common.",
        leaders: ["ols_justicar", "ols_vindicator"],
        heroes: ["ols_purifier", "ols_chaplain", "ols_sunward_initiate"],
        henchmen: ["ols_warhound", "ols_man_at_arms", "ols_vigilant"],
        sellswords: ["sell_blade_for_hire"]
      },
      {
        id: "solmiric_clergy",
        name: "Solmiric Clergy",
        description: "Priests and attendants. Dawnfather leads; Dawnguard and Dawners support.",
        leaders: ["ols_dawnfather", "ols_vindicator"],
        heroes: ["ols_dawnguard", "ols_suntouched_vessel", "ols_sunward_initiate"],
        henchmen: ["ols_dawner", "ols_man_at_arms", "ols_vigilant"],
        sellswords: ["sell_blade_for_hire"]
      }
    ]
  }
];

/* =========================================================
   UNIT EQUIPMENT PROFILE (hard slot bans)
   ========================================================= */

const UNIT_EQUIP_PROFILE = {
  ols_warhound: { noEquipment:true },
  ols_suntouched_vessel: { noHelmet:true, noArmor:true, noShield:true },
};

function unitProfile(unitId){
  return UNIT_EQUIP_PROFILE[unitId] || {};
}

/* =========================================================
   STATE
   ========================================================= */

const STORAGE_KEY = "mirrored_city_builder_lists_v2";

let state = {
  name: "",
  warbandId: WARBANDS[0]?.id || "",
  archetypeId: "",
  leaderUnitId: "",
  cards: []
};

function ensureEquipObj(obj){
  if (!obj) return { weaponIds:[], helmetId:"", armorId:"", shieldId:"", otherIds:[] };

  if (Array.isArray(obj.equipmentIds)){
    const slot = { weaponIds:[], helmetId:"", armorId:"", shieldId:"", otherIds:[] };
    for (const id of obj.equipmentIds){
      const eq = getEquip(id);
      const t = eq ? classifyEquip(eq) : "OTHER";
      if (t === "WEAPON") slot.weaponIds.push(id);
      else if (t === "HELMET" && !slot.helmetId) slot.helmetId = id;
      else if (t === "ARMOR" && !slot.armorId) slot.armorId = id;
      else if (t === "SHIELD" && !slot.shieldId) slot.shieldId = id;
      else slot.otherIds.push(id);
    }
    obj.equipment = slot;
    delete obj.equipmentIds;
  }

  if (!obj.equipment){
    obj.equipment = { weaponIds:[], helmetId:"", armorId:"", shieldId:"", otherIds:[] };
  } else {
    obj.equipment.weaponIds = Array.isArray(obj.equipment.weaponIds) ? obj.equipment.weaponIds : [];
    obj.equipment.otherIds  = Array.isArray(obj.equipment.otherIds) ? obj.equipment.otherIds : [];
    obj.equipment.helmetId  = obj.equipment.helmetId || "";
    obj.equipment.armorId   = obj.equipment.armorId || "";
    obj.equipment.shieldId  = obj.equipment.shieldId || "";
  }
  return obj.equipment;
}

function uid() { return Math.random().toString(16).slice(2) + Date.now().toString(16); }
function byId(id){ return document.getElementById(id); }

function getWarbandBase() { return WARBANDS.find(w => w.id === state.warbandId) || WARBANDS[0] || null; }
function getArchetype(warband) {
  if (!warband?.archetypes?.length) return null;
  return warband.archetypes.find(a => a.id === state.archetypeId) || warband.archetypes[0];
}
function getUnit(unitId) { return UNITS.find(u => u.id === unitId) || null; }
function getEquip(eid) { return EQUIPMENT_CATALOG[eid] || null; }

/* =========================================================
   EQUIPMENT CLASSIFICATION & STARTING FILTERS
   ========================================================= */

function classifyEquip(eq){
  const tags = eq.tags || [];
  if (tags.includes("HELMET")) return "HELMET";
  if (tags.includes("SHIELD")) return "SHIELD";
  if (tags.includes("ARMOR"))  return "ARMOR";
  if (tags.includes("WEAPON") || tags.includes("MELEE") || tags.includes("RANGED") || tags.includes("BLASTPOWDER")) return "WEAPON";
  return "OTHER";
}

function isUniqueEquipment(eq){ return (eq.tags || []).includes("UNIQUE") || !!eq.uniqueToFaction; }
function isRare(eq){ return (eq.tags || []).includes("RARE"); }
function isSpecialMaterial(eq){ return (eq.tags || []).includes("SPECIAL_MATERIAL"); }

function isBlockedByStartingMode(eq){
  const mode = byId("creationMode")?.value || "starting";
  if (mode !== "starting") return false;
  if (isRare(eq) && !isUniqueEquipment(eq)) return true;
  return false;
}

function isFactionLocked(eq, factionId){
  if (!eq.uniqueToFaction) return false;
  return eq.uniqueToFaction !== factionId;
}

/* =========================================================
   LIST-DRIVEN AVAILABILITY
   ========================================================= */

function unitFactionId(){ return state.warbandId; }

function getUnitAllowedLists(unitId, slotType){
  const access = UNIT_EQUIP_LIST_ACCESS[unitId];
  if (!access) return [];
  return (access[slotType] || []).slice();
}

function getList(listId){
  return OLS_EQUIP_LISTS[listId] || null;
}

function getEffectiveRulesFromList(listObj, eqId){
  const o = (listObj && listObj.overrides && listObj.overrides[eqId]) ? listObj.overrides[eqId] : null;
  return o || {};
}

function listAllowsItemForUnit(listObj, unitId, eqId){
  const rules = getEffectiveRulesFromList(listObj, eqId);
  if (rules.onlyUnits && rules.onlyUnits.length && !rules.onlyUnits.includes(unitId)) return false;
  if (rules.notUnits && rules.notUnits.length && rules.notUnits.includes(unitId)) return false;
  return true;
}

function isEquipAllowedForUnit(unitId, eq, slotType, listObj){
  const prof = unitProfile(unitId);
  if (prof.noEquipment) return false;

  if (slotType === "HELMET" && prof.noHelmet) return false;
  if (slotType === "ARMOR"  && prof.noArmor)  return false;
  if (slotType === "SHIELD" && prof.noShield) return false;

  if (isFactionLocked(eq, unitFactionId())) return false;
  if (isBlockedByStartingMode(eq)) return false;
  if (isSpecialMaterial(eq)) return false;

  if (classifyEquip(eq) !== slotType) return false;

  if (listObj){
    if (!listAllowsItemForUnit(listObj, unitId, eq.id)) return false;
  }

  if (slotType === "OTHER"){
    const tags = eq.tags || [];
    if (tags.includes("UNIVERSAL")) return true;
    if (isUniqueEquipment(eq)) return true;
    return false;
  }

  return true;
}

function allowedEquipmentForUnitSlot(unitId, slotType){
  const listIds = getUnitAllowedLists(unitId, slotType);
  if (!listIds.length) return [];

  const seen = new Set();
  const out = [];

  for (const listId of listIds){
    const listObj = getList(listId);
    if (!listObj) continue;

    for (const eqId of (listObj.items || [])){
      if (seen.has(eqId)) continue;
      const eq = getEquip(eqId);
      if (!eq) continue;

      if (!isEquipAllowedForUnit(unitId, eq, slotType, listObj)) continue;

      seen.add(eqId);
      out.push(eq);
    }
  }

  out.sort((a,b) => (a.name || "").localeCompare(b.name || ""));
  return out;
}

/* =========================================================
   COST PARSING
   ========================================================= */

function parseCost(costRaw){
  if (typeof costRaw === "number") return { display:String(costRaw), base:costRaw, isVariable:false, isSplit:false };
  if (typeof costRaw !== "string") return { display:"—", base:0, isVariable:true, isSplit:false };

  const raw = costRaw.trim();
  const split = raw.split("/").map(s => s.trim());
  if (split.length === 2) {
    const hero = parseCost(split[0]);
    const hench = parseCost(split[1]);
    return {
      display: raw,
      base: hero.base,
      isVariable: hero.isVariable || hench.isVariable,
      isSplit:true,
      heroBase: hero.base,
      henchBase: hench.base
    };
  }

  const m = raw.match(/^([0-9]+)\s*\+\s*(.+)$/i);
  if (m) {
    const base = parseInt(m[1], 10);
    return { display: raw, base: Number.isFinite(base)?base:0, isVariable:true, isSplit:false };
  }

  const n = parseInt(raw, 10);
  if (!Number.isNaN(n)) return { display: raw, base:n, isVariable:false, isSplit:false };

  return { display: raw, base:0, isVariable:true, isSplit:false };
}

function costForCardEquip(eq, cardKind){
  const parsed = parseCost(eq.cost);
  if (parsed.isSplit){
    const isHeroish = (cardKind === "LEADER" || cardKind === "HERO");
    const base = isHeroish ? (parsed.heroBase ?? 0) : (parsed.henchBase ?? 0);
    return { base, display: parsed.display, isVariable: parsed.isVariable };
  }
  return { base: parsed.base, display: parsed.display, isVariable: parsed.isVariable };
}

/* =========================================================
   SLOT UTIL
   ========================================================= */

function getCardEquip(card){
  if (card.kind === "LEADER"){
    state.leaderEquipment = state.leaderEquipment || { weaponIds:[], helmetId:"", armorId:"", shieldId:"", otherIds:[] };
    return state.leaderEquipment;
  }
  ensureEquipObj(card);
  return card.equipment;
}

function slotCounts(equipObj){
  return {
    WEAPON: (equipObj.weaponIds || []).length,
    HELMET: equipObj.helmetId ? 1 : 0,
    ARMOR:  equipObj.armorId ? 1 : 0,
    SHIELD: equipObj.shieldId ? 1 : 0,
    OTHER:  (equipObj.otherIds || []).length
  };
}

function canAddToSlot(equipObj, slotType){
  const counts = slotCounts(equipObj);
  return counts[slotType] < RULES.equipSlots[slotType];
}

function addEquipToSlot(equipObj, slotType, eqId){
  if (!eqId) return false;
  if (!canAddToSlot(equipObj, slotType)) return false;

  if (slotType === "WEAPON"){
    if (!equipObj.weaponIds.includes(eqId)) equipObj.weaponIds.push(eqId);
    return true;
  }
  if (slotType === "OTHER"){
    if (!equipObj.otherIds.includes(eqId)) equipObj.otherIds.push(eqId);
    return true;
  }
  if (slotType === "HELMET"){ equipObj.helmetId = eqId; return true; }
  if (slotType === "ARMOR"){  equipObj.armorId  = eqId; return true; }
  if (slotType === "SHIELD"){ equipObj.shieldId = eqId; return true; }
  return false;
}

function removeEquip(equipObj, eqId){
  if (!eqId) return;
  equipObj.weaponIds = (equipObj.weaponIds || []).filter(x => x !== eqId);
  equipObj.otherIds  = (equipObj.otherIds || []).filter(x => x !== eqId);
  if (equipObj.helmetId === eqId) equipObj.helmetId = "";
  if (equipObj.armorId === eqId)  equipObj.armorId = "";
  if (equipObj.shieldId === eqId) equipObj.shieldId = "";
}

function allEquipIds(equipObj){
  const ids = [];
  for (const x of (equipObj.weaponIds || [])) ids.push(x);
  if (equipObj.helmetId) ids.push(equipObj.helmetId);
  if (equipObj.armorId)  ids.push(equipObj.armorId);
  if (equipObj.shieldId) ids.push(equipObj.shieldId);
  for (const x of (equipObj.otherIds || [])) ids.push(x);
  return ids;
}

/* =========================================================
   COST TOTALS
   ========================================================= */

function equipmentTotalForCard(equipObj, cardKind){
  let sum = 0;
  let hasVariable = false;

  for (const id of allEquipIds(equipObj)){
    const eq = getEquip(id);
    if (!eq) continue;
    const c = costForCardEquip(eq, cardKind);
    sum += c.base;
    if (c.isVariable) hasVariable = true;
  }
  return { sum, hasVariable };
}

function cardCost(card){
  const unit = getUnit(card.unitId);
  if (!unit) return { sum:0, hasVariable:false };

  let count = 1;
  if (card.kind === "HENCHMAN") count = card.count || 1;

  const base = (unit.cost || 0) * count;
  const eq = equipmentTotalForCard(getCardEquip(card), card.kind);
  return { sum: base + eq.sum, hasVariable: eq.hasVariable };
}

function totalLumens(){
  let total = 0;
  let hasVariable = false;

  const leader = getUnit(state.leaderUnitId);
  if (leader){
    total += (leader.cost || 0);
    const eq = equipmentTotalForCard(getCardEquip({kind:"LEADER"}), "LEADER");
    total += eq.sum;
    if (eq.hasVariable) hasVariable = true;
  }

  for (const c of state.cards){
    const cc = cardCost(c);
    total += cc.sum;
    if (cc.hasVariable) hasVariable = true;
  }

  return { total, hasVariable };
}

/* =========================================================
   LISTBUILDING POOLS
   ========================================================= */

function allowedLeaderIds(warbandBase){
  const arch = getArchetype(warbandBase);
  return arch ? (arch.leaders || []).slice() : (warbandBase.leaders || []).slice();
}
function allowedUnitIdsForKind(warbandBase, kind){
  const arch = getArchetype(warbandBase);
  if (arch){
    if (kind === "HERO") return arch.heroes.slice();
    if (kind === "HENCHMAN") return arch.henchmen.slice();
    return [];
  }
  if (kind === "HERO") return (warbandBase.heroes || []).slice();
  if (kind === "HENCHMAN") return (warbandBase.henchmen || []).slice();
  return [];
}

/* =========================================================
   VALIDATION
   ========================================================= */

function clampInt(n, min, max){
  const x = parseInt(n, 10);
  if (Number.isNaN(x)) return min;
  return Math.max(min, Math.min(max, x));
}

function validate(){
  const errs = [];
  const warns = [];

  const warbandBase = getWarbandBase();
  const arch = getArchetype(warbandBase);

  const hasLeader = !!state.leaderUnitId;
  const filledNonLeaderCards = state.cards.length;
  const filledCards = (hasLeader ? 1 : 0) + filledNonLeaderCards;

  const hasHenchmanCard = state.cards.some(c => c.kind === "HENCHMAN");
  const hasOneMore = filledCards >= 3;

  const heroCardsCount = state.cards.filter(c => c.kind === "HERO").length;
  const heroesIncludingLeader = (hasLeader ? 1 : 0) + heroCardsCount;

  let hasSellsword = false;
  for (const c of state.cards){
    const u = getUnit(c.unitId);
    if (u && u.type === "SELLSWORD") hasSellsword = true;
  }

  const spentObj = totalLumens();
  const spent = spentObj.total;

  if (spent > RULES.startingLumens) errs.push(`Over budget: spent ${spent} / ${RULES.startingLumens} lumens.`);
  if (filledCards > RULES.startingStatCardsMax) errs.push(`Too many Stat Cards: ${filledCards} / ${RULES.startingStatCardsMax} (Leader counts).`);
  if (filledCards < RULES.startingStatCardsMinFilled) errs.push(`Not enough Stat Cards filled: ${filledCards} / ${RULES.startingStatCardsMinFilled} required at creation (Leader counts).`);
  if (!hasLeader) errs.push("Starting warband must include a Leader.");
  if (arch == null && (warbandBase?.archetypes?.length)) errs.push("This warband requires selecting an Archetype.");
  if (!hasHenchmanCard) errs.push("Starting warband must include at least one Henchman Card.");
  if (!hasOneMore) errs.push("Starting warband must include Leader + Henchman + one additional Stat Card (minimum 3 cards; Leader counts).");
  if (heroesIncludingLeader > RULES.startingMaxHeroesIncludingLeader) errs.push(`Too many Heroes (including Leader): ${heroesIncludingLeader} / ${RULES.startingMaxHeroesIncludingLeader}.`);
  if (!RULES.sellswordsAllowedAtCreation && hasSellsword) errs.push("Sellswords cannot be hired during warband creation.");

  if (hasLeader){
    const allowedLeaders = allowedLeaderIds(warbandBase);
    if (!allowedLeaders.includes(state.leaderUnitId)){
      const leaderUnit = getUnit(state.leaderUnitId);
      errs.push(`Leader not allowed for selected archetype: ${leaderUnit ? leaderUnit.name : state.leaderUnitId}.`);
    }
  }

  for (const c of state.cards){
    const u = getUnit(c.unitId);
    if (c.unitId){
      const allowedIds = allowedUnitIdsForKind(warbandBase, c.kind);
      if (!allowedIds.includes(c.unitId)){
        errs.push(`Invalid unit for this archetype/card type: ${(u?.name)||c.unitId} on a ${c.kind} card.`);
      }
    }

    if (c.kind === "HENCHMAN" && u){
      const isHorde = (u.tags || []).includes("HORDE");
      const max = isHorde ? 4 : 3;
      const count = clampInt(c.count, 1, max);
      if (count !== c.count){
        errs.push(`${u.name}: Henchman count must be 1–${max}${isHorde ? " (HORDE)" : ""}.`);
      }
    }

    const eqObj = getCardEquip(c);
    const counts = slotCounts(eqObj);
    for (const slot of ["WEAPON","HELMET","ARMOR","SHIELD","OTHER"]){
      if (counts[slot] > RULES.equipSlots[slot]){
        errs.push(`${u?.name || "Card"}: too many items in ${slot} slot (${counts[slot]} / ${RULES.equipSlots[slot]}).`);
      }
    }

    for (const id of allEquipIds(eqObj)){
      const eq = getEquip(id);
      if (!eq){
        warns.push(`${u?.name || "Card"}: unknown equipment id (${id}).`);
        continue;
      }
      const slot = classifyEquip(eq);
      const allowed = allowedEquipmentForUnitSlot(c.unitId, slot).some(x => x.id === id);
      if (!allowed){
        errs.push(`${u?.name || "Unit"}: cannot take ${eq.name}.`);
      }
    }
  }

  if (hasLeader){
    const eqObj = getCardEquip({kind:"LEADER"});
    const counts = slotCounts(eqObj);
    for (const slot of ["WEAPON","HELMET","ARMOR","SHIELD","OTHER"]){
      if (counts[slot] > RULES.equipSlots[slot]){
        errs.push(`Leader: too many items in ${slot} slot (${counts[slot]} / ${RULES.equipSlots[slot]}).`);
      }
    }
    for (const id of allEquipIds(eqObj)){
      const eq = getEquip(id);
      if (!eq){
        warns.push(`Leader: unknown equipment id (${id}).`);
        continue;
      }
      const slot = classifyEquip(eq);
      const allowed = allowedEquipmentForUnitSlot(state.leaderUnitId, slot).some(x => x.id === id);
      if (!allowed){
        errs.push(`${getUnit(state.leaderUnitId)?.name || "Leader"}: cannot take ${eq.name}.`);
      }
    }
  }

  return {
    errs,
    warns,
    meta: {
      hasLeader,
      hasHenchmanCard,
      hasOneMore,
      meetsMinCards: filledCards >= RULES.startingStatCardsMinFilled,
      noSellswords: !hasSellsword,
      filledCards,
      heroesIncludingLeader,
      spent,
      spentHasVariable: spentObj.hasVariable
    }
  };
}

/* =========================================================
   RENDER
   ========================================================= */

function render(){
  byId("rosterName").value = state.name || "";

  const warbandBase = getWarbandBase();

  const wbSel = byId("warbandSelect");
  wbSel.innerHTML = "";
  for (const w of WARBANDS){
    const opt = document.createElement("option");
    opt.value = w.id;
    opt.textContent = w.name;
    wbSel.appendChild(opt);
  }
  wbSel.value = state.warbandId;
  byId("warbandDesc").textContent = warbandBase?.description || "";

  const archSel = byId("archetypeSelect");
  archSel.innerHTML = "";
  const archetypes = warbandBase?.archetypes || [];
  if (!archetypes.length){
    archSel.disabled = true;
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "— (No archetypes) —";
    archSel.appendChild(opt);
    byId("archetypeDesc").textContent = "";
    state.archetypeId = "";
  } else {
    archSel.disabled = false;
    if (!state.archetypeId) state.archetypeId = archetypes[0].id;
    for (const a of archetypes){
      const opt = document.createElement("option");
      opt.value = a.id;
      opt.textContent = a.name;
      archSel.appendChild(opt);
    }
    archSel.value = state.archetypeId;
    byId("archetypeDesc").textContent = (getArchetype(warbandBase)?.description) || "";
  }

  const leaderSel = byId("leaderSelect");
  leaderSel.innerHTML = "";
  const ph = document.createElement("option");
  ph.value = "";
  ph.textContent = "— Select Leader —";
  leaderSel.appendChild(ph);

  const leaderIds = allowedLeaderIds(warbandBase);
  for (const id of leaderIds){
    const u = getUnit(id);
    if (!u) continue;
    const opt = document.createElement("option");
    opt.value = id;
    opt.textContent = `${u.name} (${u.cost} lumens)`;
    leaderSel.appendChild(opt);
  }
  leaderSel.value = state.leaderUnitId || "";

  if (state.leaderUnitId){
    state.leaderEquipment = state.leaderEquipment || { weaponIds:[], helmetId:"", armorId:"", shieldId:"", otherIds:[] };
  } else {
    delete state.leaderEquipment;
  }

  const cardsEl = byId("cards");
  cardsEl.innerHTML = "";

  if (state.leaderUnitId){
    cardsEl.appendChild(renderLeaderStatCard());
  }

  for (const c of state.cards){
    cardsEl.appendChild(renderStatCard(c, warbandBase));
  }

  const v = validate();
  renderSummary(v);

  byId("jsonPreview").value = JSON.stringify(safeExportState(), null, 2);

  save();
}

function renderLeaderStatCard(){
  const wrap = document.createElement("div");
  wrap.className = "card";

  const leaderUnit = getUnit(state.leaderUnitId);
  const leaderCard = { kind:"LEADER", unitId: state.leaderUnitId, count:1 };
  const cc = (() => {
    const eq = equipmentTotalForCard(getCardEquip(leaderCard), "LEADER");
    const base = leaderUnit ? (leaderUnit.cost || 0) : 0;
    return { sum: base + eq.sum, hasVariable: eq.hasVariable };
  })();

  wrap.innerHTML = `
    <div class="card-top">
      <div class="card-title">
        <span>LEADER Stat Card</span>
        <span class="pill">Counts as 1 Card</span>
        <span class="pill">Cost: ${cc.sum}${cc.hasVariable ? "+" : ""}</span>
      </div>
      <button class="noPrint" disabled>Leader</button>
    </div>

    <div class="muted">Leader: <strong>${leaderUnit ? leaderUnit.name : "—"}</strong></div>

    <div id="leaderEquipHost"></div>
  `;

  const host = wrap.querySelector("#leaderEquipHost");
  renderEquipmentSlotsUI(host, leaderCard, "LEADER");

  return wrap;
}

function renderStatCard(card, warbandBase){
  ensureEquipObj(card);

  const wrap = document.createElement("div");
  wrap.className = "card";

  const kindLabel = card.kind === "HERO" ? "HERO" : "HENCHMAN";
  const unit = getUnit(card.unitId);
  const isHorde = unit && (unit.tags || []).includes("HORDE");
  const maxCount = (card.kind === "HENCHMAN") ? (isHorde ? 4 : 3) : 1;

  const cc = cardCost(card);

  wrap.innerHTML = `
    <div class="card-top">
      <div class="card-title">
        <span>${kindLabel} Card</span>
        ${isHorde ? `<span class="pill warn">HORDE</span>` : ""}
        <span class="pill">Cost: ${cc.sum}${cc.hasVariable ? "+" : ""}</span>
        ${unit?.limit ? `<span class="pill">${unit.limit}</span>` : ""}
      </div>
      <button class="noPrint" id="rm_${card.id}">Remove</button>
    </div>

    <div class="row two">
      <div>
        <label>Unit</label>
        <select id="unit_${card.id}"></select>
      </div>
      <div>
        <label>Count ${card.kind === "HENCHMAN" ? `(1–${maxCount})` : ""}</label>
        <input id="count_${card.id}" type="number" min="1" max="${maxCount}" ${card.kind === "HENCHMAN" ? "" : "disabled"} />
        <div class="tiny">${card.kind === "HENCHMAN" ? (isHorde ? "HORDE henchmen can be 1–4." : "Henchmen are 1–3.") : "Heroes are always 1 model."}</div>
      </div>
    </div>

    <div id="equipHost_${card.id}"></div>
  `;

  wrap.querySelector(`#rm_${card.id}`).addEventListener("click", () => {
    state.cards = state.cards.filter(c => c.id !== card.id);
    render();
  });

  const unitSel = wrap.querySelector(`#unit_${card.id}`);
  unitSel.innerHTML = "";
  const allowedIds = allowedUnitIdsForKind(warbandBase, card.kind);

  const ph = document.createElement("option");
  ph.value = "";
  ph.textContent = "— Select Unit —";
  unitSel.appendChild(ph);

  for (const id of allowedIds){
    const u = getUnit(id);
    if (!u) continue;
    const opt = document.createElement("option");
    opt.value = id;
    opt.textContent = `${u.name} (${u.cost} lumens${(u.tags||[]).includes("HORDE") ? ", HORDE" : ""}${u.type==="SELLSWORD" ? ", SELLSWORD" : ""})`;
    unitSel.appendChild(opt);
  }

  unitSel.value = card.unitId || "";
  unitSel.addEventListener("change", () => {
    card.unitId = unitSel.value;

    const u = getUnit(card.unitId);
    const horde = u && (u.tags||[]).includes("HORDE");
    const max = (card.kind === "HENCHMAN") ? (horde ? 4 : 3) : 1;
    card.count = clampInt(card.count || 1, 1, max);

    pruneIllegalEquipmentForCard(card);
    render();
  });

  const countEl = wrap.querySelector(`#count_${card.id}`);
  if (card.kind === "HENCHMAN"){
    countEl.value = card.count || 1;
    countEl.addEventListener("input", () => {
      const u = getUnit(card.unitId);
      const horde = u && (u.tags||[]).includes("HORDE");
      const max = horde ? 4 : 3;
      card.count = clampInt(countEl.value, 1, max);
      render();
    });
  } else {
    countEl.value = 1;
    card.count = 1;
  }

  const host = wrap.querySelector(`#equipHost_${card.id}`);
  renderEquipmentSlotsUI(host, card, card.kind);

  return wrap;
}

function pruneIllegalEquipmentForCard(card){
  const unitId = card.unitId;
  const eqObj = getCardEquip(card);

  if (!unitId){
    eqObj.weaponIds = [];
    eqObj.otherIds = [];
    eqObj.helmetId = "";
    eqObj.armorId = "";
    eqObj.shieldId = "";
    return;
  }

  const allowedWeapons = new Set(allowedEquipmentForUnitSlot(unitId, "WEAPON").map(e=>e.id));
  const allowedHelmets = new Set(allowedEquipmentForUnitSlot(unitId, "HELMET").map(e=>e.id));
  const allowedArmor   = new Set(allowedEquipmentForUnitSlot(unitId, "ARMOR").map(e=>e.id));
  const allowedShield  = new Set(allowedEquipmentForUnitSlot(unitId, "SHIELD").map(e=>e.id));
  const allowedOther   = new Set(allowedEquipmentForUnitSlot(unitId, "OTHER").map(e=>e.id));

  eqObj.weaponIds = (eqObj.weaponIds || []).filter(id => allowedWeapons.has(id)).slice(0, RULES.equipSlots.WEAPON);
  eqObj.otherIds  = (eqObj.otherIds || []).filter(id => allowedOther.has(id)).slice(0, RULES.equipSlots.OTHER);

  if (eqObj.helmetId && !allowedHelmets.has(eqObj.helmetId)) eqObj.helmetId = "";
  if (eqObj.armorId && !allowedArmor.has(eqObj.armorId)) eqObj.armorId = "";
  if (eqObj.shieldId && !allowedShield.has(eqObj.shieldId)) eqObj.shieldId = "";
}

function pruneIllegalEquipmentForLeader(){
  const unitId = state.leaderUnitId;
  if (!unitId || !state.leaderEquipment) return;

  const eqObj = state.leaderEquipment;

  const allowedWeapons = new Set(allowedEquipmentForUnitSlot(unitId, "WEAPON").map(e=>e.id));
  const allowedHelmets = new Set(allowedEquipmentForUnitSlot(unitId, "HELMET").map(e=>e.id));
  const allowedArmor   = new Set(allowedEquipmentForUnitSlot(unitId, "ARMOR").map(e=>e.id));
  const allowedShield  = new Set(allowedEquipmentForUnitSlot(unitId, "SHIELD").map(e=>e.id));
  const allowedOther   = new Set(allowedEquipmentForUnitSlot(unitId, "OTHER").map(e=>e.id));

  eqObj.weaponIds = (eqObj.weaponIds || []).filter(id => allowedWeapons.has(id)).slice(0, RULES.equipSlots.WEAPON);
  eqObj.otherIds  = (eqObj.otherIds || []).filter(id => allowedOther.has(id)).slice(0, RULES.equipSlots.OTHER);

  if (eqObj.helmetId && !allowedHelmets.has(eqObj.helmetId)) eqObj.helmetId = "";
  if (eqObj.armorId && !allowedArmor.has(eqObj.armorId)) eqObj.armorId = "";
  if (eqObj.shieldId && !allowedShield.has(eqObj.shieldId)) eqObj.shieldId = "";
}

/* =========================================================
   EQUIPMENT UI: render ONLY slots that exist
   ========================================================= */

function renderEquipmentSlotsUI(host, card, cardKind){
  host.innerHTML = "";

  const unitId = (cardKind === "LEADER") ? state.leaderUnitId : card.unitId;
  const eqObj = getCardEquip(card);

  if (!unitId){
    const t = document.createElement("div");
    t.className = "tiny";
    t.style.marginTop = "10px";
    t.textContent = "Select a unit to see available equipment.";
    host.appendChild(t);
    return;
  }

  const prof = unitProfile(unitId);

  if (prof.noEquipment){
    const t = document.createElement("div");
    t.className = "tiny";
    t.style.marginTop = "10px";
    t.textContent = "This unit cannot take equipment.";
    host.appendChild(t);
    return;
  }

  const slotDefs = [
    { key:"WEAPON", label:"Weapons", hint:`Up to ${RULES.equipSlots.WEAPON}`, multi:true },
    { key:"HELMET", label:"Helmet", hint:`${RULES.equipSlots.HELMET}`, multi:false },
    { key:"ARMOR",  label:"Armor",  hint:`${RULES.equipSlots.ARMOR}`, multi:false },
    { key:"SHIELD", label:"Shield", hint:`${RULES.equipSlots.SHIELD}`, multi:false },
    { key:"OTHER",  label:"Everything Else", hint:`Up to ${RULES.equipSlots.OTHER}`, multi:true }
  ];

  const slotGrid = document.createElement("div");
  slotGrid.className = "slotGrid";

  for (const s of slotDefs){
    const banned =
      (s.key === "HELMET" && prof.noHelmet) ||
      (s.key === "ARMOR"  && prof.noArmor) ||
      (s.key === "SHIELD" && prof.noShield);

    const selectedIds = getSelectedIdsForSlot(eqObj, s.key);
    const allowed = banned ? [] : allowedEquipmentForUnitSlot(unitId, s.key);

    // Hide if banned AND nothing selected
    if (banned && !selectedIds.length) continue;

    // Hide if no options and nothing selected
    if (!allowed.length && !selectedIds.length) continue;

    const box = document.createElement("div");
    box.className = "slotBox";

    const counts = slotCounts(eqObj);
    const max = RULES.equipSlots[s.key];
    const count = counts[s.key];

    const selId = `sel_${s.key}_${cardKind}_${card.id || "leader"}`;
    const btnId = `btn_${s.key}_${cardKind}_${card.id || "leader"}`;
    const listId = `list_${s.key}_${cardKind}_${card.id || "leader"}`;
    const helpId = `help_${s.key}_${cardKind}_${card.id || "leader"}`;

    box.innerHTML = `
      <div class="slotHdr">
        <strong>${s.label}</strong>
        <span>${count} / ${max}</span>
      </div>
      <div class="tiny">${s.hint}</div>

      <div class="slotAddRow">
        <div>
          <label>Add</label>
          <select id="${selId}">
            <option value="">— Choose —</option>
          </select>
          <div class="tiny" id="${helpId}"></div>
        </div>
        <button class="noPrint" id="${btnId}">Add</button>
      </div>

      <div class="equipList" id="${listId}"></div>
    `;

    slotGrid.appendChild(box);

    const sel = box.querySelector("#" + selId);
    const btn = box.querySelector("#" + btnId);
    const help = box.querySelector("#" + helpId);
    const list = box.querySelector("#" + listId);

    if (banned){
      sel.style.display = "none";
      btn.style.display = "none";
      box.querySelector("label").style.display = "none";
      help.textContent = "This unit cannot use this slot.";
      renderSlotChips(list, card, cardKind, s.key);
      continue;
    }

    const chosenSingle = (s.key === "HELMET" ? eqObj.helmetId :
                          s.key === "ARMOR"  ? eqObj.armorId :
                          s.key === "SHIELD" ? eqObj.shieldId : "");

    const filtered = allowed.filter(eq => {
      if (!eq) return false;
      if (!s.multi && chosenSingle && eq.id === chosenSingle) return false;
      if (s.key === "WEAPON" && (eqObj.weaponIds || []).includes(eq.id)) return false;
      if (s.key === "OTHER"  && (eqObj.otherIds || []).includes(eq.id)) return false;
      return true;
    });

    if (!filtered.length){
      sel.style.display = "none";
      btn.style.display = "none";
      box.querySelector("label").style.display = "none";
      help.textContent = selectedIds.length ? "No additional items available for this slot." : "No available items for this slot.";
      renderSlotChips(list, card, cardKind, s.key);
      continue;
    }

    for (const eq of filtered){
      const c = costForCardEquip(eq, cardKind === "LEADER" ? "LEADER" : cardKind);
      const bits = [];
      if (isUniqueEquipment(eq)) bits.push("Unique");
      if (isRare(eq)) bits.push("Rare");
      if (c.isVariable) bits.push("var");

      const opt = document.createElement("option");
      opt.value = eq.id;
      opt.textContent = `${eq.name} (${c.display}${bits.length ? " • " + bits.join(", ") : ""})`;
      sel.appendChild(opt);
    }

    btn.disabled = !canAddToSlot(eqObj, s.key);
    help.textContent = btn.disabled ? "Slot is full." : "Choose an item and click Add.";

    btn.addEventListener("click", () => {
      const id = sel.value;
      if (!id) return;
      if (!canAddToSlot(eqObj, s.key)) return;
      addEquipToSlot(eqObj, s.key, id);
      render();
    });

    renderSlotChips(list, card, cardKind, s.key);
  }

  if (!slotGrid.children.length){
    const t = document.createElement("div");
    t.className = "tiny";
    t.style.marginTop = "10px";
    t.textContent = "No equipment options are available for this unit.";
    host.appendChild(t);
    return;
  }

  host.appendChild(slotGrid);
}

function getSelectedIdsForSlot(eqObj, slotKey){
  if (slotKey === "WEAPON") return (eqObj.weaponIds || []).slice();
  if (slotKey === "OTHER")  return (eqObj.otherIds || []).slice();
  if (slotKey === "HELMET") return eqObj.helmetId ? [eqObj.helmetId] : [];
  if (slotKey === "ARMOR")  return eqObj.armorId ? [eqObj.armorId] : [];
  if (slotKey === "SHIELD") return eqObj.shieldId ? [eqObj.shieldId] : [];
  return [];
}

function renderSlotChips(container, card, cardKind, slotKey){
  const eqObj = getCardEquip(card);

  let ids = [];
  if (slotKey === "WEAPON") ids = (eqObj.weaponIds || []).slice();
  else if (slotKey === "OTHER") ids = (eqObj.otherIds || []).slice();
  else if (slotKey === "HELMET" && eqObj.helmetId) ids = [eqObj.helmetId];
  else if (slotKey === "ARMOR" && eqObj.armorId) ids = [eqObj.armorId];
  else if (slotKey === "SHIELD" && eqObj.shieldId) ids = [eqObj.shieldId];

  container.innerHTML = "";
  if (!ids.length){
    const t = document.createElement("div");
    t.className = "tiny";
    t.textContent = "None selected.";
    container.appendChild(t);
    return;
  }

  for (const id of ids){
    const eq = getEquip(id);
    const chip = document.createElement("div");
    chip.className = "equipChip";

    const c = eq ? costForCardEquip(eq, cardKind === "LEADER" ? "LEADER" : cardKind) : { display:"—", base:0, isVariable:true };
    const meta = [];
    if (eq && isUniqueEquipment(eq)) meta.push("Unique");
    if (eq && isRare(eq)) meta.push("Rare");
    if (c.isVariable) meta.push("var");

    chip.innerHTML = `
      <span>${eq ? eq.name : id}</span>
      <span class="tagMini">${eq ? `${c.display}${meta.length ? " • " + meta.join(", ") : ""}` : ""}</span>
      <span class="x" title="Remove">×</span>
    `;

    chip.querySelector(".x").addEventListener("click", () => {
      removeEquip(eqObj, id);
      render();
    });

    container.appendChild(chip);
  }
}

/* =========================================================
   SUMMARY UI
   ========================================================= */

function setReqPill(id, ok){
  const el = byId(id);
  el.classList.remove("good","bad");
  el.classList.add(ok ? "good" : "bad");
}

function renderSummary(v){
  const spent = v.meta.spent;
  const remaining = RULES.startingLumens - spent;

  byId("lumensText").textContent = `${spent}${v.meta.spentHasVariable ? "+" : ""} / ${RULES.startingLumens}`;
  byId("lumensSub").textContent = `Remaining: ${remaining}${v.meta.spentHasVariable ? " (some costs are variable)" : ""}`;

  const lumBox = byId("statLumens");
  lumBox.classList.toggle("badBorder", remaining < 0);
  lumBox.classList.toggle("goodBorder", remaining >= 0);

  byId("cardsText").textContent = `${v.meta.filledCards} / ${RULES.startingStatCardsMax}`;
  byId("cardsSub").textContent = `Minimum at creation: ${RULES.startingStatCardsMinFilled}`;

  const cardsBox = byId("statCards");
  cardsBox.classList.toggle("badBorder", v.meta.filledCards > RULES.startingStatCardsMax || v.meta.filledCards < RULES.startingStatCardsMinFilled);
  cardsBox.classList.toggle("goodBorder", v.meta.filledCards >= RULES.startingStatCardsMinFilled && v.meta.filledCards <= RULES.startingStatCardsMax);

  byId("heroesText").textContent = `${v.meta.heroesIncludingLeader} / ${RULES.startingMaxHeroesIncludingLeader}`;
  const heroBox = byId("statHeroes");
  heroBox.classList.toggle("badBorder", v.meta.heroesIncludingLeader > RULES.startingMaxHeroesIncludingLeader);
  heroBox.classList.toggle("goodBorder", v.meta.heroesIncludingLeader <= RULES.startingMaxHeroesIncludingLeader);

  setReqPill("reqLeader", v.meta.hasLeader);
  setReqPill("reqHench", v.meta.hasHenchmanCard);
  setReqPill("reqOneMore", v.meta.hasOneMore);
  setReqPill("reqMinCards", v.meta.meetsMinCards);
  setReqPill("reqNoSells", v.meta.noSellswords);

  const box = byId("messages");
  box.innerHTML = "";

  if (v.errs.length === 0 && v.warns.length === 0){
    const ok = document.createElement("div");
    ok.className = "okBox";
    ok.textContent = "Looks good so far. This roster passes the starting-warband checks.";
    box.appendChild(ok);
  } else {
    for (const e of v.errs){
      const el = document.createElement("div");
      el.className = "err";
      el.textContent = e;
      box.appendChild(el);
    }
    for (const w of v.warns){
      const el = document.createElement("div");
      el.className = "warnBox";
      el.textContent = w;
      box.appendChild(el);
    }
  }
}

/* =========================================================
   EVENTS
   ========================================================= */

byId("rosterName").addEventListener("input", (e) => { state.name = e.target.value; render(); });

byId("warbandSelect").addEventListener("change", (e) => {
  state.warbandId = e.target.value;
  state.archetypeId = "";
  state.leaderUnitId = "";
  state.cards = [];
  delete state.leaderEquipment;
  render();
});

byId("archetypeSelect").addEventListener("change", (e) => {
  state.archetypeId = e.target.value;
  state.leaderUnitId = "";
  state.cards = [];
  delete state.leaderEquipment;
  render();
});

byId("leaderSelect").addEventListener("change", (e) => {
  state.leaderUnitId = e.target.value;
  if (state.leaderUnitId){
    state.leaderEquipment = { weaponIds:[], helmetId:"", armorId:"", shieldId:"", otherIds:[] };
  } else {
    delete state.leaderEquipment;
  }
  render();
});

byId("btnAddHero").addEventListener("click", () => {
  state.cards.push({ id: uid(), kind: "HERO", unitId: "", count: 1, equipment: { weaponIds:[], helmetId:"", armorId:"", shieldId:"", otherIds:[] } });
  render();
});

byId("btnAddHench").addEventListener("click", () => {
  state.cards.push({ id: uid(), kind: "HENCHMAN", unitId: "", count: 1, equipment: { weaponIds:[], helmetId:"", armorId:"", shieldId:"", otherIds:[] } });
  render();
});

byId("btnReset").addEventListener("click", () => {
  if (!confirm("Reset roster? This clears saved data in this browser.")) return;
  localStorage.removeItem(STORAGE_KEY);
  state = { name:"", warbandId: WARBANDS[0]?.id || "", archetypeId:"", leaderUnitId:"", cards: [] };
  render();
});

byId("btnPrint").addEventListener("click", () => window.print());
byId("btnExport").addEventListener("click", () => exportRoster());
byId("btnImport").addEventListener("click", () => importRoster());

/* =========================================================
   SAVE / LOAD / EXPORT
   ========================================================= */

function safeExportState(){
  return {
    version: 3,
    roster: {
      name: state.name,
      warbandId: state.warbandId,
      archetypeId: state.archetypeId,
      leaderUnitId: state.leaderUnitId,
      leaderEquipment: state.leaderEquipment || { weaponIds:[], helmetId:"", armorId:"", shieldId:"", otherIds:[] },
      cards: state.cards.map(c => ({
        id: c.id,
        kind: c.kind,
        unitId: c.unitId,
        count: c.count,
        equipment: ensureEquipObj(c) && c.equipment
      }))
    }
  };
}

function applyImported(obj){
  if (!obj || !obj.roster) throw new Error("Invalid roster format.");

  const r = obj.roster;
  state.name = r.name || "";
  state.warbandId = r.warbandId || (WARBANDS[0]?.id || "");
  state.archetypeId = r.archetypeId || "";
  state.leaderUnitId = r.leaderUnitId || "";

  state.leaderEquipment = r.leaderEquipment || { weaponIds:[], helmetId:"", armorId:"", shieldId:"", otherIds:[] };

  const importedCards = Array.isArray(r.cards) ? r.cards : [];
  state.cards = importedCards.map(c => {
    const card = {
      id: c.id || uid(),
      kind: c.kind,
      unitId: c.unitId || "",
      count: c.count || 1,
      equipment: c.equipment || { weaponIds:[], helmetId:"", armorId:"", shieldId:"", otherIds:[] }
    };
    ensureEquipObj(card);
    return card;
  });

  if (!state.leaderUnitId) delete state.leaderEquipment;
  if (state.leaderUnitId) pruneIllegalEquipmentForLeader();
  for (const c of state.cards) pruneIllegalEquipmentForCard(c);
}

function save(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(safeExportState())); }catch{} }

function load(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return false;
    applyImported(JSON.parse(raw));
    return true;
  }catch{ return false; }
}

function exportRoster(){
  const obj = safeExportState();
  const json = JSON.stringify(obj, null, 2);
  const blob = new Blob([json], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = (state.name ? state.name.replace(/[^\w\- ]+/g,"").trim().replace(/\s+/g,"_") : "noble_roster") + ".json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function importRoster(){
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "application/json";
  input.addEventListener("change", () => {
    const file = input.files && input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        applyImported(JSON.parse(String(reader.result || "")));
        render();
      }catch(e){
        alert("Import failed: " + (e && e.message ? e.message : "Invalid JSON"));
      }
    };
    reader.readAsText(file);
  });
  input.click();
}

/* =========================================================
   BOOT
   ========================================================= */

(function boot(){
  load();
  if (!state.warbandId && WARBANDS[0]) state.warbandId = WARBANDS[0].id;
  render();
})();
</script>
</body>
</html>
